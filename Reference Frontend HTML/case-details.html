<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patent Gap - Case Details</title>
  
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #EDEADC;
            color: #0A1F14;
        }

        .top-nav {
            background-color: #0A1F14;
            color: #EDEADC;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 3px solid #191970;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Merriweather', serif;
        }

        .nav-brand img {
            height: 40px;
            width: auto;
        }

        .back-btn {
            background-color: #191970;
            color: #EDEADC;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background-color: #2A2A8A;
            color: #EDEADC;
            text-decoration: underline;
            text-decoration-color: #EDEADC;
            text-underline-offset: 4px;
            text-decoration-thickness: 2px;
        }

        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .case-header {
            background: #F8F7F3;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
            border: 1px solid #D8D6C4;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .case-title {
            font-family: 'Merriweather', serif;
            color: #0A1F14;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .case-subtitle {
            color: #0A1F14;
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
        }

        .case-meta {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .meta-item {
            text-align: center;
        }

        .meta-label {
            font-size: 0.9rem;
            color: #0A1F14;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .meta-value {
            font-size: 1rem;
            color: #0A1F14;
            font-weight: 600;
        }

        .section-card {
            background: #F8F7F3;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
            border: 1px solid #D8D6C4;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #0A1F14;
            color: #EDEADC;
            padding: 1.5rem;
            font-family: 'Merriweather', serif;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-content {
            padding: 2rem;
        }

        .case-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #0A1F14;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        .info-value {
            font-size: 1.1rem;
            color: #0A1F14;
            padding: 0.5rem 0;
        }

        .status-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #EDEADC;
        }

        .status-active {
            background-color: #0A1F14;
        }

        .status-pending {
            background-color: #191970;
        }

        .status-completed {
            background-color: #3A5F5A;
        }

        .status-in-progress {
            background-color: #191970;
        }

        .status-under-review {
            background-color: #191970;
        }

        .status-cancelled,
        .status-rejected {
            background-color: #8B4513;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .accept-btn {
            background: rgb(0, 148, 0);
            color: #EDEADC;
            padding: 1rem 2rem;
            font-size: 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #191970;
            color: #EDEADC;
        }

        .btn-primary:hover {
            background: #2A2A8A;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 25, 112, 0.3);
        }

        .btn-secondary {
            background: #3A5F5A;
            color: #EDEADC;
        }

        .btn-secondary:hover {
            background: #4A6F6A;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 95, 90, 0.3);
        }

        .references-list {
            list-style: none;
            padding: 0;
        }

        .reference-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #EDEADC;
            border-radius: 8px;
            border-left: 4px solid #191970;
        }

        .reference-link {
            color: #191970;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .reference-link:hover {
            text-decoration: underline;
            text-decoration-color: #191970;
            text-underline-offset: 3px;
        }

        .reference-meta {
            font-size: 0.9rem;
            color: #0A1F14;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .keyword-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            color: #EDEADC;
        }

        .keyword-active {
            background-color: #0A1F14;
        }

        .keyword-pending {
            background-color: #191970;
        }

        .keyword-completed {
            background-color: #3A5F5A;
        }

        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #D8D6C4;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #191970;
        }

        .timeline-date {
            font-size: 0.9rem;
            color: #0A1F14;
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }

        .timeline-content {
            color: #0A1F14;
            line-height: 1.6;
        }

        .patents-section {
            background: #F8F7F3;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
            border: 1px solid #D8D6C4;
            overflow: hidden;
        }

        .patents-header {
            background: #0A1F14;
            color: #EDEADC;
            padding: 1.5rem;
            font-family: 'Merriweather', serif;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .patents-content {
            padding: 2rem;
        }

        .patents-list {
            display: grid;
            gap: 1.5rem;
            padding: 0rem 1.5rem;
        }

        .patent-card {
            border: 1px solid #D8D6C4;
            border-radius: 12px;
            padding: 1.5rem;
            background: #EDEADC;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .patent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #191970;            
        }

        .patent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .patent-title {
            font-family: 'Merriweather', serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: #0A1F14;
            flex: 1;
            margin-right: 1rem;
        }

        .summary-card {
            background: #F8F7F3;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
            border: 1px solid #D8D6C4;
            overflow: hidden;
            padding: 1.5rem;
        }

        .similarity-rate {
            background: #3A5F5A;
            color: #EDEADC;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .patent-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .patent-detail-item {
            display: flex;
            flex-direction: column;
        }

        .patent-detail-label {
            font-size: 0.8rem;
            color: #0A1F14;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3rem;
            opacity: 0.7;
        }

        .patent-detail-value {
            font-size: 1rem;
            color: #0A1F14;
            font-weight: 500;
        }

        .patent-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #0A1F14;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #191970;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #0A1F14;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .error-message {
            background-color: #F8D7DA;
            color: #721C24;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            border: 1px solid #F5C6CB;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .case-title {
                font-size: 2rem;
            }

            .case-meta {
                flex-direction: column;
                gap: 1rem;
            }

            .case-info-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .patent-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .similarity-rate {
                margin-top: 0.5rem;
            }

            .patent-details {
                grid-template-columns: 1fr;
            }

            .patent-actions {
                flex-direction: column;
            }
        }

        .icon-btn-white {
            background: none;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            margin-left: auto;
            width: 2em;
            height: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0.1rem 0.3rem 0.3rem 0.3rem;
            color: white;
        }

        .icon-btn-white:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .icon-btn-white span {
            font-size: 1.3em;
            line-height: 1;
        }

        .close-popup-btn {
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            color: white;
            padding: 0rem 1rem;
        }

        .keywords-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 0rem;
            z-index: 1000;
            min-width: 300px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        .keywords-popup input {
            width: 60%;
            padding: 0.8rem 1rem;
            border: 1px solid black;
            border-radius: 10px;
            font-size: 1.5rem;
            background: white;
            color: #0A1F14;
            transition: all 0.3s ease;
        }

        .keywords-popup-disabled {
            display: none;
        }

        .keywords-popup-header {
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 1rem; 
            background-color: #0A1F14; 
            color: white;
            padding: 2rem 1rem;
        }

        .keywords-list {
            padding: 1rem 3rem;
            list-style: none;
        }

        .keywords-input {
            margin: 0.5rem 0.5rem 2rem 2rem;
        }

        .keyword-card {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0A1F14;
            border: 2px solid white;
            border-radius: 12px;
            padding: 0.5rem 1rem;
            color: white;
        }

        .keyword-card .keyword-text {
            margin-right: 1rem;
        }

        .keyword-card .delete-keyword-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 1rem;
            background: none;
            border: 2px solid white;
            border-radius: 50%;
            height: 3rem;
            width: 3rem;
            padding: 2px 3px;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="nav-brand">
            <img src="images/logo-white-nobg.png" alt="Patent Gap Logo">
            Patent Gap - Case Details
        </div>
        <a href="/home" class="back-btn">‚Üê Back to Dashboard</a>
    </div>

    <div class="main-content">
       
        <div class="case-header">
            <h1 class="case-title" id="caseTitle">Loading Case Details...</h1>
            <p class="case-subtitle" id="caseSubtitle">Patent Application Analysis</p>
        </div>

        
        <div class="section-card">
            <div class="section-header">
                Case Information
            </div>
            <div class="section-content">
                <div id="caseLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading case details...</p>
                </div>

                <div id="caseError" class="error-message" style="display: none;">
                    <p>Error loading case details. Please try again.</p>
                </div>

                <div id="caseDetails" style="display: none;">
                    <div class="case-info-grid">
                        <div class="info-item">
                            <div class="info-label">Case Title</div>
                            <div class="info-value" id="caseTitleDetail">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Date of Filing</div>
                            <div class="info-value" id="filingDateDetail">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Status</div>
                            <div class="info-value">
                                <span id="caseStatusDetail" class="status-badge">-</span>
                            </div>
                        </div>
                        <div class="info-item" id="acceptedOnItem" style="display: none;">
                            <div class="info-label">Accepted On</div>
                            <div class="info-value" id="acceptedOn">-</div>
                        </div>
                        <div class="info-item" id="acceptedByItem" style="display: none;">
                            <div class="info-label">Accepted By</div>
                            <div class="info-value" id="acceptedBy">-</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="viewApplication()">
                            üìÑ View Application
                        </button>
                        <button class="btn btn-secondary" onclick="viewPatentDocuments()">
                            üìã View Patent Documents
                        </button>
                        <button class="btn btn-secondary" onclick="updateStatus()">
                            ‚úèÔ∏è Update Status
                        </button>
                    </div>
                </div>
            </div>
        </div>

    
        <div class="section-card">
            <div class="section-header">
                Description
            </div>
            <div class="section-content">
                <p id="caseDescription">Loading case description...</p>
            </div>
        </div>

    
        <div class="section-card">
            <div class="section-header">
                References
            </div>
            <div class="section-content">
                <ul class="references-list" id="referencesList">
                    <li class="reference-item">
                        <a href="#" class="reference-link">US Patent 10,123,456 - Machine Learning Methods for Patent Classification</a>
                        <div class="reference-meta">Filed: 2020-03-15 | Status: Granted</div>
                    </li>
                    <li class="reference-item">
                        <a href="#" class="reference-link">US Patent 9,876,543 - Automated Document Analysis Using Neural Networks</a>
                        <div class="reference-meta">Filed: 2019-08-22 | Status: Granted</div>
                    </li>
                    <li class="reference-item">
                        <a href="#" class="reference-link">US Patent 10,987,654 - Intelligent Search Algorithms for Patent Databases</a>
                        <div class="reference-meta">Filed: 2021-11-10 | Status: Pending</div>
                    </li>
                </ul>
            </div>
        </div>

       
        <div class="section-card">
            <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
                <span>Keywords</span>
                <button 
                    class="icon-btn-white" 
                    title="Add Keyword"
                    onclick="renderKeywordsPopup()"
                >
                    <span>&#43;</span>
                </button>
            </div>
            <div class="section-content">
                <div class="keywords-container">
                    <span class="keyword-badge keyword-active">Machine Learning</span>
                    <span class="keyword-badge keyword-pending">Patent Analysis</span>
                    <span class="keyword-badge keyword-completed">Document Processing</span>
                    <span class="keyword-badge keyword-active">AI Technology</span>
                    <span class="keyword-badge keyword-pending">Neural Networks</span>
                    <span class="keyword-badge keyword-completed">Data Mining</span>
                    <span class="keyword-badge keyword-active">Intellectual Property</span>
                    <span class="keyword-badge keyword-pending">Automation</span>
                </div>
            </div>
        </div>

        
        <div class="section-card">
            <div class="section-header">
                Timeline
            </div>
            <div class="section-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-date">2024-01-15</div>
                        <div class="timeline-content">Case created and assigned to review queue</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">2024-01-20</div>
                        <div class="timeline-content">Initial analysis completed, references identified</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">2024-02-01</div>
                        <div class="timeline-content">Case accepted for detailed review</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">2024-02-15</div>
                        <div class="timeline-content">Patent similarity analysis completed</div>
                    </div>
                </div>
            </div>
        </div>

       
        <div class="patents-section">
            <div class="patents-header">
                Related Patents
            </div>
            <div class="patents-content">
                <div id="patentsLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading related patents...</p>
                </div>

                <div id="patentsError" class="error-message" style="display: none;">
                    <p>Error loading related patents. Please try again.</p>
                </div>

                <div id="patentsEmpty" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üîç</div>
                    <h3>No Related Patents Found</h3>
                    <p>No patents are currently associated with this case.</p>
                </div>

                <div id="patentsList" class="patents-list" style="display: none;">
                    <!-- Patent cards will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let caseId = null;
        let caseData = null;

        async function getCurrentUser() {
            const response = await fetch('/api/profile');
            const data = await response.json();
            return data.user;
        }

        function getCaseIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        function renderAcceptSection(accepted_on, accepted_by) {
            accepted_on_main_element = document.getElementById('acceptedOnItem');
            accepted_by_main_element = document.getElementById('acceptedByItem');

            accepted_on_element = document.getElementById('acceptedOn');
            accepted_by_element = document.getElementById('acceptedBy');
            // Check if the case has been accepted (i.e., has accepted_on and accepted_by)
            if (caseData && caseData.accepted_on || caseData.accepted_by) {
                // Case is accepted
                // Show accepted fields only if they exist
                if (caseData.accepted_on) {
                    accepted_on_element.style.display = 'flex';
                    accepted_on_element.textContent = caseData.accepted_on;
                }

                if (caseData.accepted_by) {
                    accepted_by_element.style.display = 'flex';
                    accepted_by_element.textContent = caseData.accepted_by;
                }
            } 
            else {
                // Case is not accepted, render the Accept button
                accepted_on_main_element.style.display = 'flex';
                accepted_on_main_element.innerHTML = `<button class="accept-btn" onclick="acceptCase()"><span style="font-size:1.5em;font-weight:bold;vertical-align:middle;margin-right:0.5em;">&#10003;</span>Accept Case</button>`;
                accepted_by_main_element.innerHTML = '';
            }
        }
        
        function renderReferencesSection(references) {
            references_element = document.getElementById('referencesList');
            references_element.innerHTML = '';
            references.forEach(reference => {
                let referenceItem = `<li class="reference-item">
                    <a href="${reference.url || '#'}" class="reference-link" target="_blank" rel="noopener noreferrer">${reference.title}</a>
                    <div class="reference-meta">Filed: ${reference.granted_date}</div>
                </li>`;
                references_element.innerHTML += referenceItem;

            });
        }

        function renderSummarySection(summary) {
            main_div = document.getElementById('main-content');
            summaryDiv = document.createElement('div');
            summaryDiv.className = 'summary-card';
            summaryDiv.innerHTML = summary;
            main_div.appendChild(summaryDiv);
        }

        // Functions related to Edit Keywords Popup
        function removeKeyword(keyword) {
            if (caseData) {
                caseData.keywords = caseData.keywords.filter(k => k !== keyword);
                updateCase();
            }
        }
        function submitKeywords() {
            let keywords = document.getElementById('keywordsInput').value;
            keywords = keywords.split(',');
            keywords = keywords.map(keyword => keyword.trim());
            if (caseData) {
                caseData.keywords = keywords;
                updateCase();
            }
        }
        function closePopup() {
            var popup = document.getElementById('keywordsPopup');
            popup.style.display = 'none';
            popup.className = 'keywords-popup-disabled';
            if (popup) {
                popup.parentNode.removeChild(popup);
            }
        }
        function renderKeywordsPopup() {
            let keywordsPopup = document.getElementById('keywordsPopup');
            if (!keywordsPopup) {
                keywordsPopup = document.createElement('div');
                keywordsPopup.id = 'keywordsPopup';
                document.body.appendChild(keywordsPopup);
            }
            keywordsPopup.style.display = 'block';
            document.getElementById('keywordsPopup').innerHTML = `
                <div class="keywords-popup">
                    <div class="keywords-popup-header">
                        <h3 style="margin: 0;">Add Keywords</h3>
                        <button class="close-popup-btn" onclick="closePopup()" title="Close"> &times;</button>
                    </div>
                    <ul id="keywordsList" class="keywords-list">
                        ${
                            (caseData && Array.isArray(caseData.keywords) && caseData.keywords.length > 0)
                            ? caseData.keywords.map(keyword => `
                                <li class="keyword-card">
                                    <span class="keyword-text">${keyword}</span>
                                    <button class="delete-keyword-btn" onclick="removeKeyword('${keyword.replace(/'/g, "\\'")}')" title="Remove keyword">
                                        &#128465;
                                    </button>
                                </li>
                              `).join('')
                            : '<li class="no-keywords">No keywords added yet.</li>'
                        }
                    </ul>
                    <input type="text" id="keywordsInput" class="keywords-input" placeholder="Telecom, Software, Medicine">
                    <button onclick="submitKeywords()" class="btn btn-primary" style="margin: 0rem 2rem 0rem 0rem;">Submit</button>
                </div>
            `;
        }

        async function loadCaseDetails() {
            caseId = getCaseIdFromUrl();
            
            if (!caseId) {
                showCaseError('No case ID provided');
                return;
            }

            try {
                // Simulate API call - replace with actual endpoint
                const response = await fetch(`/api/cases/${caseId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load case details');
                }

                const data = await response.json();
                
                if (data.success) {
                    caseData = data.case;
                    displayCaseDetails(caseData);
                } else {
                    throw new Error(data.message || 'Failed to load case details');
                }
            } catch (error) {
                console.error('Error loading case details:', error);
                // For demo purposes, use mock data
                caseData = getMockCaseData(caseId);
                displayCaseDetails(caseData);
            }
        }

        // Display case details
        function displayCaseDetails(caseData) {
            document.getElementById('caseLoading').style.display = 'none';
            document.getElementById('caseError').style.display = 'none';
            document.getElementById('caseDetails').style.display = 'block';

            // Update header
            document.getElementById('caseTitle').textContent = caseData.title || 'Untitled Case';

            // Update details section
            document.getElementById('caseTitleDetail').textContent = caseData.title || 'N/A';
            document.getElementById('filingDateDetail').textContent = caseData.filing_date || 'N/A';
            
            const statusDetailElement = document.getElementById('caseStatusDetail');
            statusDetailElement.textContent = caseData.status || 'Unknown';
            statusDetailElement.className = `status-badge status-${getStatusClass(caseData.status)}`;

            // Show accepted fields only if they exist
            renderAcceptSection(caseData.accepted_on, caseData.accepted_by);

            // Show references section
            renderReferencesSection(caseData.references);

            // Update description
            document.getElementById('caseDescription').textContent = caseData.description || 'No description available for this case.';
        }

        // Show case error
        function showCaseError(message) {
            document.getElementById('caseLoading').style.display = 'none';
            document.getElementById('caseError').style.display = 'block';
            document.getElementById('caseError').querySelector('p').textContent = message;
        }

        // Helper function to get status class for styling
        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'active':
                    return 'active';
                case 'completed':
                case 'closed':
                    return 'completed';
                case 'pending':
                case 'new':
                    return 'pending';
                case 'under review':
                case 'in progress':
                    return 'under-review';
                case 'cancelled':
                case 'rejected':
                    return 'cancelled';
                default:
                    return 'pending';
            }
        }

        // Load related patents
        async function loadRelatedPatents() {
            if (!caseId) return;

            try {
                // Simulate API call - replace with actual endpoint
                const response = await fetch(`/api/cases/${caseId}/patents`);
                
                if (!response.ok) {
                    throw new Error('Failed to load related patents');
                }

                const data = await response.json();
                
                if (data.success) {
                    console.log('Related Patent Data: '+data.patents);
                    displayRelatedPatents(data.patents);
                } else {
                    throw new Error(data.message || 'Failed to load related patents');
                }
            } catch (error) {
                console.error('Error loading related patents:', error);
                // For demo purposes, use mock data
                const mockPatents = getMockPatentsData(caseId);
                displayRelatedPatents(mockPatents);
            }
        }

        // Display related patents
        function displayRelatedPatents(patents) {
            document.getElementById('patentsLoading').style.display = 'none';
            document.getElementById('patentsError').style.display = 'none';

            if (!patents || patents.length === 0) {
                document.getElementById('patentsEmpty').style.display = 'block';
                return;
            }

            document.getElementById('patentsList').style.display = 'block';
            
            const patentsList = document.getElementById('patentsList');
            patentsList.innerHTML = '';

            patents.forEach(patent => {
                const patentCard = createPatentCard(patent);
                patentsList.appendChild(patentCard);
            });
        }

        // Create patent card element
        function createPatentCard(patent) {
            const card = document.createElement('div');
            card.className = 'patent-card';
            
            card.innerHTML = `
                <div class="patent-header">
                    <div class="patent-title">${patent.title || 'N/A'}</div>
                    <div class="similarity-rate">Similarity Rate: ${patent.similarity_rate || 0}%</div>
                </div>
                <div class="patent-actions">
                    <button class="btn btn-primary btn-small" onclick="viewPatentDocument('${patent.id}')">
                        üìã View Patent Documents
                    </button>
                </div>
            `;
            
            return card;
        }

        // Mock data functions (replace with actual API calls)
        function getMockCaseData(caseId) {
            return {
                id: caseId,
                title: 'AI-Powered Patent Analysis System',
                filing_date: '2024-01-15',
                status: 'In Progress',
                accepted_on: '2024-02-01',
                accepted_by: 'Dr. Jane Smith',
                description: 'This case involves the development of an advanced AI-powered system for automated patent analysis and classification. The system utilizes machine learning algorithms to analyze patent documents, identify key concepts, and provide similarity analysis with existing patents in the database.'
            };
        }

        function getMockPatentsData(caseId) {
            return [
                {
                    id: 'patent_001',
                    title: 'Machine Learning Methods for Patent Classification',
                    granted_date: '2023-06-15',
                    similarity_rate: 85
                },
                {
                    id: 'patent_002',
                    title: 'Automated Document Analysis Using Neural Networks',
                    granted_date: '2023-08-22',
                    similarity_rate: 72
                },
                {
                    id: 'patent_003',
                    title: 'Intelligent Search Algorithms for Patent Databases',
                    granted_date: '2023-11-10',
                    similarity_rate: 68
                },
                {
                    id: 'patent_004',
                    title: 'Natural Language Processing for Legal Document Review',
                    granted_date: '2024-01-05',
                    similarity_rate: 91
                }
            ];
        }

        // Action functions
        function viewApplication() {
            if (caseData) {
                alert(`Opening application for case: ${caseData.title}\n\nThis would typically open the full application document.`);
            }
        }

        function viewPatentDocuments() {
            if (caseData) {
                alert(`Opening patent documents for case: ${caseData.title}\n\nThis would typically open all related patent documents.`);
            }
        }

        function updateCase() {
            if (caseData) {
                fetch(`/api/cases/${encodeURIComponent(caseData.id)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(caseData),
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Case updated successfully!');
                        loadCaseDetails();
                    } else {
                        alert('Failed to update case: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('Error updating case: ' + err);
                });
            }
        }

        function acceptCase() {
            if (caseData) {
                caseData.accepted_by = getCurrentUser().id;
                caseData.accepted_on = new Date().toISOString().split('T')[0];
                updateCase();
            }
        }

        function updateStatus() {
            if (caseData) {
                if (!caseData.accepted_by || !caseData.accepted_on) {
                    // Case has not been accepted yet, proceed with accept logic
                    caseData.accepted_by = getCurrentUser().id;
                    caseData.accepted_on = new Date().toISOString().split('T')[0];
                }
                // Example: Prompt for new status and send update to backend
                const newStatus = prompt("Enter new status for this case:", caseData.status || "");
                if (newStatus && newStatus !== caseData.status) {
                    updateCase();
                }
                alert(`Updating status for case: ${caseData.title}\n\nThis would open the status update interface.`);
            }
        }

        function viewPatentDocument(patentId) {
            alert(`Opening patent document: ${patentId}\n\nThis would typically open the specific patent document.`);
        }

        function addKeyword(keyword) {
            if (caseData) {
                caseData.keywords.push(keyword);
                updateCase();
            }
        }

        function removeKeyword(keyword) {
            if (caseData) {
                caseData.keywords = caseData.keywords.filter(k => k !== keyword);
                updateCase();
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCaseDetails();
            loadRelatedPatents();
        });
    </script>
</body>
</html>

